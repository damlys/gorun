image: damlys/gorun-devcontainer:0.2.103
definitions:
  caches:
    core-tfmod-main: projects/core/terraform-modules/main/.terraform
    core-tfmod-prod: projects/core/terraform-modules/prod/.terraform
    core-tfmod-test: projects/core/terraform-modules/test/.terraform
    core-tfsub-gcp-docker-images-registry: projects/core/terraform-submodules/gcp-docker-images-registry/.terraform
    core-tfsub-gcp-helm-charts-registry: projects/core/terraform-submodules/gcp-helm-charts-registry/.terraform
    core-tfsub-gcp-project: projects/core/terraform-submodules/gcp-project/.terraform
    core-tfsub-gcp-terraform-modules-registry: projects/core/terraform-submodules/gcp-terraform-modules-registry/.terraform
    core-tfsub-gcp-terraform-state-bucket: projects/core/terraform-submodules/gcp-terraform-state-bucket/.terraform
    core-tfsub-gke-platform: projects/core/terraform-submodules/gke-platform/.terraform
    core-tfsub-gke-service-account: projects/core/terraform-submodules/gke-service-account/.terraform
    core-tfsub-k8s-gateway-redirect: projects/core/terraform-submodules/k8s-gateway-redirect/.terraform
    core-tfsub-k8s-gateway-route: projects/core/terraform-submodules/k8s-gateway-route/.terraform
    core-tfsub-k8s-vault: projects/core/terraform-submodules/k8s-vault/.terraform
    core-tfsub-k8s-workspace: projects/core/terraform-submodules/k8s-workspace/.terraform
    demo-tfmod-kuard: projects/demo/terraform-modules/kuard/.terraform
    demo-tfsub-helm-manifest: projects/demo/terraform-submodules/helm-manifest/.terraform
    demo-tfsub-helm-template: projects/demo/terraform-submodules/helm-template/.terraform
    demo-tfsub-kuard: projects/demo/terraform-submodules/kuard/.terraform
    o11y-tfmod-test: projects/o11y/terraform-modules/test/.terraform
    o11y-tfsub-gcp-availability-monitor: projects/o11y/terraform-submodules/gcp-availability-monitor/.terraform
    o11y-tfsub-gke-lgtm-stack: projects/o11y/terraform-submodules/gke-lgtm-stack/.terraform
    o11y-tfsub-k8s-otel-collectors: projects/o11y/terraform-submodules/k8s-otel-collectors/.terraform
  scripts:
    - &auth |
      set -e
      echo "$GOOGLE_CREDENTIALS" | gcloud auth activate-service-account --key-file="/dev/stdin"
      export GOOGLE_APPLICATION_CREDENTIALS="/tmp/GOOGLE_APPLICATION_CREDENTIALS.json" && echo "$GOOGLE_CREDENTIALS" >"$GOOGLE_APPLICATION_CREDENTIALS"
      gcloud auth configure-docker "europe-central2-docker.pkg.dev"
      gcloud auth print-access-token | helm registry login --username="oauth2accesstoken" --password-stdin "europe-central2-docker.pkg.dev"
  steps:
    - step: &test-core-image-devcontainer
        name: test core-image-devcontainer
        condition:
          changesets:
            includePaths:
              - "projects/core/docker-images/devcontainer/**"
        services:
          - docker
        caches:
          - docker
        script:
          - *auth
          - ./scripts/docker-image build "projects/core/docker-images/devcontainer"
          - ./scripts/docker-image test "projects/core/docker-images/devcontainer"
          - ./scripts/docker-image pre-publish "projects/core/docker-images/devcontainer"
          - ./scripts/docker-image show "projects/core/docker-images/devcontainer"
    - step: &publish-core-image-devcontainer
        name: publish core-image-devcontainer
        condition:
          changesets:
            includePaths:
              - "projects/core/docker-images/devcontainer/**"
        services:
          - docker
        caches:
          - docker
        script:
          - *auth
          - ./scripts/docker-image build "projects/core/docker-images/devcontainer"
          - ./scripts/docker-image test "projects/core/docker-images/devcontainer"
          - ./scripts/docker-image publish "projects/core/docker-images/devcontainer"
          - ./scripts/docker-image show "projects/core/docker-images/devcontainer"
    - step: &test-core-image-go-rte
        name: test core-image-go-rte
        condition:
          changesets:
            includePaths:
              - "projects/core/docker-images/go-rte/**"
        services:
          - docker
        caches:
          - docker
        script:
          - *auth
          - ./scripts/docker-image build "projects/core/docker-images/go-rte"
          - ./scripts/docker-image test "projects/core/docker-images/go-rte"
          - ./scripts/docker-image pre-publish "projects/core/docker-images/go-rte"
          - ./scripts/docker-image show "projects/core/docker-images/go-rte"
    - step: &publish-core-image-go-rte
        name: publish core-image-go-rte
        condition:
          changesets:
            includePaths:
              - "projects/core/docker-images/go-rte/**"
        services:
          - docker
        caches:
          - docker
        script:
          - *auth
          - ./scripts/docker-image build "projects/core/docker-images/go-rte"
          - ./scripts/docker-image test "projects/core/docker-images/go-rte"
          - ./scripts/docker-image publish "projects/core/docker-images/go-rte"
          - ./scripts/docker-image show "projects/core/docker-images/go-rte"
    - step: &test-core-image-go-sdk
        name: test core-image-go-sdk
        condition:
          changesets:
            includePaths:
              - "projects/core/docker-images/go-sdk/**"
        services:
          - docker
        caches:
          - docker
        script:
          - *auth
          - ./scripts/docker-image build "projects/core/docker-images/go-sdk"
          - ./scripts/docker-image test "projects/core/docker-images/go-sdk"
          - ./scripts/docker-image pre-publish "projects/core/docker-images/go-sdk"
          - ./scripts/docker-image show "projects/core/docker-images/go-sdk"
    - step: &publish-core-image-go-sdk
        name: publish core-image-go-sdk
        condition:
          changesets:
            includePaths:
              - "projects/core/docker-images/go-sdk/**"
        services:
          - docker
        caches:
          - docker
        script:
          - *auth
          - ./scripts/docker-image build "projects/core/docker-images/go-sdk"
          - ./scripts/docker-image test "projects/core/docker-images/go-sdk"
          - ./scripts/docker-image publish "projects/core/docker-images/go-sdk"
          - ./scripts/docker-image show "projects/core/docker-images/go-sdk"
    - step: &test-core-tfmod-main
        name: test core-tfmod-main
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-modules/main/**"
        caches:
          - core-tfmod-main
        script:
          - *auth
          - ./scripts/terraform-module test "projects/core/terraform-modules/main"
    - step: &plan-core-tfmod-main
        name: plan core-tfmod-main
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-modules/main/**"
        caches:
          - core-tfmod-main
        script:
          - *auth
          - terraform -chdir="projects/core/terraform-modules/main" init -input="false"
          - terraform -chdir="projects/core/terraform-modules/main" plan -input="false"
    - step: &apply-core-tfmod-main
        name: apply core-tfmod-main
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-modules/main/**"
        caches:
          - core-tfmod-main
        script:
          - *auth
          - terraform -chdir="projects/core/terraform-modules/main" init -input="false"
          - terraform -chdir="projects/core/terraform-modules/main" apply -input="false" -auto-approve
        trigger: manual
    - step: &test-core-tfmod-prod
        name: test core-tfmod-prod
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-modules/prod/**"
        caches:
          - core-tfmod-prod
        script:
          - *auth
          - ./scripts/terraform-module test "projects/core/terraform-modules/prod"
    - step: &plan-core-tfmod-prod
        name: plan core-tfmod-prod
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-modules/prod/**"
        caches:
          - core-tfmod-prod
        script:
          - *auth
          - terraform -chdir="projects/core/terraform-modules/prod" init -input="false"
          - terraform -chdir="projects/core/terraform-modules/prod" plan -input="false"
    - step: &apply-core-tfmod-prod
        name: apply core-tfmod-prod
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-modules/prod/**"
        caches:
          - core-tfmod-prod
        script:
          - *auth
          - terraform -chdir="projects/core/terraform-modules/prod" init -input="false"
          - terraform -chdir="projects/core/terraform-modules/prod" apply -input="false" -auto-approve
        trigger: manual
    - step: &test-core-tfmod-test
        name: test core-tfmod-test
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-modules/test/**"
        caches:
          - core-tfmod-test
        script:
          - *auth
          - ./scripts/terraform-module test "projects/core/terraform-modules/test"
    - step: &plan-core-tfmod-test
        name: plan core-tfmod-test
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-modules/test/**"
        caches:
          - core-tfmod-test
        script:
          - *auth
          - terraform -chdir="projects/core/terraform-modules/test" init -input="false"
          - terraform -chdir="projects/core/terraform-modules/test" plan -input="false"
    - step: &apply-core-tfmod-test
        name: apply core-tfmod-test
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-modules/test/**"
        caches:
          - core-tfmod-test
        script:
          - *auth
          - terraform -chdir="projects/core/terraform-modules/test" init -input="false"
          - terraform -chdir="projects/core/terraform-modules/test" apply -input="false" -auto-approve
        trigger: manual
    - step: &test-core-tfsub-gcp-docker-images-registry
        name: test core-tfsub-gcp-docker-images-registry
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-docker-images-registry/**"
        caches:
          - core-tfsub-gcp-docker-images-registry
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-docker-images-registry"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-docker-images-registry"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/gcp-docker-images-registry"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-docker-images-registry"
    - step: &publish-core-tfsub-gcp-docker-images-registry
        name: publish core-tfsub-gcp-docker-images-registry
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-docker-images-registry/**"
        caches:
          - core-tfsub-gcp-docker-images-registry
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-docker-images-registry"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-docker-images-registry"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/gcp-docker-images-registry"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-docker-images-registry"
    - step: &test-core-tfsub-gcp-helm-charts-registry
        name: test core-tfsub-gcp-helm-charts-registry
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-helm-charts-registry/**"
        caches:
          - core-tfsub-gcp-helm-charts-registry
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-helm-charts-registry"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-helm-charts-registry"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/gcp-helm-charts-registry"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-helm-charts-registry"
    - step: &publish-core-tfsub-gcp-helm-charts-registry
        name: publish core-tfsub-gcp-helm-charts-registry
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-helm-charts-registry/**"
        caches:
          - core-tfsub-gcp-helm-charts-registry
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-helm-charts-registry"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-helm-charts-registry"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/gcp-helm-charts-registry"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-helm-charts-registry"
    - step: &test-core-tfsub-gcp-project
        name: test core-tfsub-gcp-project
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-project/**"
        caches:
          - core-tfsub-gcp-project
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-project"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-project"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/gcp-project"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-project"
    - step: &publish-core-tfsub-gcp-project
        name: publish core-tfsub-gcp-project
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-project/**"
        caches:
          - core-tfsub-gcp-project
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-project"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-project"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/gcp-project"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-project"
    - step: &test-core-tfsub-gcp-terraform-modules-registry
        name: test core-tfsub-gcp-terraform-modules-registry
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-terraform-modules-registry/**"
        caches:
          - core-tfsub-gcp-terraform-modules-registry
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-terraform-modules-registry"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-terraform-modules-registry"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/gcp-terraform-modules-registry"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-terraform-modules-registry"
    - step: &publish-core-tfsub-gcp-terraform-modules-registry
        name: publish core-tfsub-gcp-terraform-modules-registry
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-terraform-modules-registry/**"
        caches:
          - core-tfsub-gcp-terraform-modules-registry
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-terraform-modules-registry"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-terraform-modules-registry"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/gcp-terraform-modules-registry"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-terraform-modules-registry"
    - step: &test-core-tfsub-gcp-terraform-state-bucket
        name: test core-tfsub-gcp-terraform-state-bucket
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-terraform-state-bucket/**"
        caches:
          - core-tfsub-gcp-terraform-state-bucket
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-terraform-state-bucket"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-terraform-state-bucket"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/gcp-terraform-state-bucket"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-terraform-state-bucket"
    - step: &publish-core-tfsub-gcp-terraform-state-bucket
        name: publish core-tfsub-gcp-terraform-state-bucket
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gcp-terraform-state-bucket/**"
        caches:
          - core-tfsub-gcp-terraform-state-bucket
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gcp-terraform-state-bucket"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gcp-terraform-state-bucket"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/gcp-terraform-state-bucket"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gcp-terraform-state-bucket"
    - step: &test-core-tfsub-gke-platform
        name: test core-tfsub-gke-platform
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gke-platform/**"
        caches:
          - core-tfsub-gke-platform
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gke-platform"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gke-platform"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/gke-platform"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gke-platform"
    - step: &publish-core-tfsub-gke-platform
        name: publish core-tfsub-gke-platform
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gke-platform/**"
        caches:
          - core-tfsub-gke-platform
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gke-platform"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gke-platform"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/gke-platform"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gke-platform"
    - step: &test-core-tfsub-gke-service-account
        name: test core-tfsub-gke-service-account
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gke-service-account/**"
        caches:
          - core-tfsub-gke-service-account
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gke-service-account"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gke-service-account"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/gke-service-account"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gke-service-account"
    - step: &publish-core-tfsub-gke-service-account
        name: publish core-tfsub-gke-service-account
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/gke-service-account/**"
        caches:
          - core-tfsub-gke-service-account
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/gke-service-account"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/gke-service-account"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/gke-service-account"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/gke-service-account"
    - step: &test-core-tfsub-k8s-gateway-redirect
        name: test core-tfsub-k8s-gateway-redirect
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/k8s-gateway-redirect/**"
        caches:
          - core-tfsub-k8s-gateway-redirect
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/k8s-gateway-redirect"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/k8s-gateway-redirect"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/k8s-gateway-redirect"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/k8s-gateway-redirect"
    - step: &publish-core-tfsub-k8s-gateway-redirect
        name: publish core-tfsub-k8s-gateway-redirect
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/k8s-gateway-redirect/**"
        caches:
          - core-tfsub-k8s-gateway-redirect
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/k8s-gateway-redirect"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/k8s-gateway-redirect"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/k8s-gateway-redirect"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/k8s-gateway-redirect"
    - step: &test-core-tfsub-k8s-gateway-route
        name: test core-tfsub-k8s-gateway-route
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/k8s-gateway-route/**"
        caches:
          - core-tfsub-k8s-gateway-route
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/k8s-gateway-route"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/k8s-gateway-route"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/k8s-gateway-route"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/k8s-gateway-route"
    - step: &publish-core-tfsub-k8s-gateway-route
        name: publish core-tfsub-k8s-gateway-route
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/k8s-gateway-route/**"
        caches:
          - core-tfsub-k8s-gateway-route
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/k8s-gateway-route"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/k8s-gateway-route"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/k8s-gateway-route"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/k8s-gateway-route"
    - step: &test-core-tfsub-k8s-vault
        name: test core-tfsub-k8s-vault
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/k8s-vault/**"
        caches:
          - core-tfsub-k8s-vault
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/k8s-vault"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/k8s-vault"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/k8s-vault"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/k8s-vault"
    - step: &publish-core-tfsub-k8s-vault
        name: publish core-tfsub-k8s-vault
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/k8s-vault/**"
        caches:
          - core-tfsub-k8s-vault
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/k8s-vault"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/k8s-vault"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/k8s-vault"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/k8s-vault"
    - step: &test-core-tfsub-k8s-workspace
        name: test core-tfsub-k8s-workspace
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/k8s-workspace/**"
        caches:
          - core-tfsub-k8s-workspace
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/k8s-workspace"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/k8s-workspace"
          - ./scripts/terraform-submodule pre-publish "projects/core/terraform-submodules/k8s-workspace"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/k8s-workspace"
    - step: &publish-core-tfsub-k8s-workspace
        name: publish core-tfsub-k8s-workspace
        condition:
          changesets:
            includePaths:
              - "projects/core/terraform-submodules/k8s-workspace/**"
        caches:
          - core-tfsub-k8s-workspace
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/core/terraform-submodules/k8s-workspace"
          - ./scripts/terraform-submodule test "projects/core/terraform-submodules/k8s-workspace"
          - ./scripts/terraform-submodule publish "projects/core/terraform-submodules/k8s-workspace"
          - ./scripts/terraform-submodule show "projects/core/terraform-submodules/k8s-workspace"
    - step: &test-demo-image-kuard
        name: test demo-image-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/docker-images/kuard/**"
        services:
          - docker
        caches:
          - docker
        script:
          - *auth
          - ./scripts/docker-image build "projects/demo/docker-images/kuard"
          - ./scripts/docker-image test "projects/demo/docker-images/kuard"
          - ./scripts/docker-image pre-publish "projects/demo/docker-images/kuard"
          - ./scripts/docker-image show "projects/demo/docker-images/kuard"
    - step: &publish-demo-image-kuard
        name: publish demo-image-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/docker-images/kuard/**"
        services:
          - docker
        caches:
          - docker
        script:
          - *auth
          - ./scripts/docker-image build "projects/demo/docker-images/kuard"
          - ./scripts/docker-image test "projects/demo/docker-images/kuard"
          - ./scripts/docker-image publish "projects/demo/docker-images/kuard"
          - ./scripts/docker-image show "projects/demo/docker-images/kuard"
    - step: &test-demo-gomod-kuard-tester
        name: test demo-gomod-kuard-tester
        condition:
          changesets:
            includePaths:
              - "projects/demo/go-modules/kuard-tester/**"
        script:
          - *auth
          - ./scripts/go-module test "projects/demo/go-modules/kuard-tester"
    - step: &test-demo-chart-stateful-kuard
        name: test demo-chart-stateful-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/helm-charts/stateful-kuard/**"
        script:
          - *auth
          - ./scripts/helm-chart build "projects/demo/helm-charts/stateful-kuard"
          - ./scripts/helm-chart test "projects/demo/helm-charts/stateful-kuard"
          - ./scripts/helm-chart pre-publish "projects/demo/helm-charts/stateful-kuard"
          - ./scripts/helm-chart show "projects/demo/helm-charts/stateful-kuard"
    - step: &publish-demo-chart-stateful-kuard
        name: publish demo-chart-stateful-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/helm-charts/stateful-kuard/**"
        script:
          - *auth
          - ./scripts/helm-chart build "projects/demo/helm-charts/stateful-kuard"
          - ./scripts/helm-chart test "projects/demo/helm-charts/stateful-kuard"
          - ./scripts/helm-chart publish "projects/demo/helm-charts/stateful-kuard"
          - ./scripts/helm-chart show "projects/demo/helm-charts/stateful-kuard"
    - step: &test-demo-chart-stateless-kuard
        name: test demo-chart-stateless-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/helm-charts/stateless-kuard/**"
        script:
          - *auth
          - ./scripts/helm-chart build "projects/demo/helm-charts/stateless-kuard"
          - ./scripts/helm-chart test "projects/demo/helm-charts/stateless-kuard"
          - ./scripts/helm-chart pre-publish "projects/demo/helm-charts/stateless-kuard"
          - ./scripts/helm-chart show "projects/demo/helm-charts/stateless-kuard"
    - step: &publish-demo-chart-stateless-kuard
        name: publish demo-chart-stateless-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/helm-charts/stateless-kuard/**"
        script:
          - *auth
          - ./scripts/helm-chart build "projects/demo/helm-charts/stateless-kuard"
          - ./scripts/helm-chart test "projects/demo/helm-charts/stateless-kuard"
          - ./scripts/helm-chart publish "projects/demo/helm-charts/stateless-kuard"
          - ./scripts/helm-chart show "projects/demo/helm-charts/stateless-kuard"
    - step: &test-demo-tfmod-kuard
        name: test demo-tfmod-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/terraform-modules/kuard/**"
        caches:
          - demo-tfmod-kuard
        script:
          - *auth
          - ./scripts/terraform-module test "projects/demo/terraform-modules/kuard"
    - step: &plan-demo-tfmod-kuard
        name: plan demo-tfmod-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/terraform-modules/kuard/**"
        caches:
          - demo-tfmod-kuard
        script:
          - *auth
          - terraform -chdir="projects/demo/terraform-modules/kuard" init -input="false"
          - terraform -chdir="projects/demo/terraform-modules/kuard" plan -input="false"
    - step: &apply-demo-tfmod-kuard
        name: apply demo-tfmod-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/terraform-modules/kuard/**"
        caches:
          - demo-tfmod-kuard
        script:
          - *auth
          - terraform -chdir="projects/demo/terraform-modules/kuard" init -input="false"
          - terraform -chdir="projects/demo/terraform-modules/kuard" apply -input="false" -auto-approve
        trigger: manual
    - step: &test-demo-tfsub-helm-manifest
        name: test demo-tfsub-helm-manifest
        condition:
          changesets:
            includePaths:
              - "projects/demo/terraform-submodules/helm-manifest/**"
        caches:
          - demo-tfsub-helm-manifest
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/demo/terraform-submodules/helm-manifest"
          - ./scripts/terraform-submodule test "projects/demo/terraform-submodules/helm-manifest"
          - ./scripts/terraform-submodule pre-publish "projects/demo/terraform-submodules/helm-manifest"
          - ./scripts/terraform-submodule show "projects/demo/terraform-submodules/helm-manifest"
    - step: &publish-demo-tfsub-helm-manifest
        name: publish demo-tfsub-helm-manifest
        condition:
          changesets:
            includePaths:
              - "projects/demo/terraform-submodules/helm-manifest/**"
        caches:
          - demo-tfsub-helm-manifest
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/demo/terraform-submodules/helm-manifest"
          - ./scripts/terraform-submodule test "projects/demo/terraform-submodules/helm-manifest"
          - ./scripts/terraform-submodule publish "projects/demo/terraform-submodules/helm-manifest"
          - ./scripts/terraform-submodule show "projects/demo/terraform-submodules/helm-manifest"
    - step: &test-demo-tfsub-helm-template
        name: test demo-tfsub-helm-template
        condition:
          changesets:
            includePaths:
              - "projects/demo/terraform-submodules/helm-template/**"
        caches:
          - demo-tfsub-helm-template
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/demo/terraform-submodules/helm-template"
          - ./scripts/terraform-submodule test "projects/demo/terraform-submodules/helm-template"
          - ./scripts/terraform-submodule pre-publish "projects/demo/terraform-submodules/helm-template"
          - ./scripts/terraform-submodule show "projects/demo/terraform-submodules/helm-template"
    - step: &publish-demo-tfsub-helm-template
        name: publish demo-tfsub-helm-template
        condition:
          changesets:
            includePaths:
              - "projects/demo/terraform-submodules/helm-template/**"
        caches:
          - demo-tfsub-helm-template
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/demo/terraform-submodules/helm-template"
          - ./scripts/terraform-submodule test "projects/demo/terraform-submodules/helm-template"
          - ./scripts/terraform-submodule publish "projects/demo/terraform-submodules/helm-template"
          - ./scripts/terraform-submodule show "projects/demo/terraform-submodules/helm-template"
    - step: &test-demo-tfsub-kuard
        name: test demo-tfsub-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/terraform-submodules/kuard/**"
        caches:
          - demo-tfsub-kuard
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/demo/terraform-submodules/kuard"
          - ./scripts/terraform-submodule test "projects/demo/terraform-submodules/kuard"
          - ./scripts/terraform-submodule pre-publish "projects/demo/terraform-submodules/kuard"
          - ./scripts/terraform-submodule show "projects/demo/terraform-submodules/kuard"
    - step: &publish-demo-tfsub-kuard
        name: publish demo-tfsub-kuard
        condition:
          changesets:
            includePaths:
              - "projects/demo/terraform-submodules/kuard/**"
        caches:
          - demo-tfsub-kuard
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/demo/terraform-submodules/kuard"
          - ./scripts/terraform-submodule test "projects/demo/terraform-submodules/kuard"
          - ./scripts/terraform-submodule publish "projects/demo/terraform-submodules/kuard"
          - ./scripts/terraform-submodule show "projects/demo/terraform-submodules/kuard"
    - step: &test-o11y-tfmod-test
        name: test o11y-tfmod-test
        condition:
          changesets:
            includePaths:
              - "projects/o11y/terraform-modules/test/**"
        caches:
          - o11y-tfmod-test
        script:
          - *auth
          - ./scripts/terraform-module test "projects/o11y/terraform-modules/test"
    - step: &plan-o11y-tfmod-test
        name: plan o11y-tfmod-test
        condition:
          changesets:
            includePaths:
              - "projects/o11y/terraform-modules/test/**"
        caches:
          - o11y-tfmod-test
        script:
          - *auth
          - terraform -chdir="projects/o11y/terraform-modules/test" init -input="false"
          - terraform -chdir="projects/o11y/terraform-modules/test" plan -input="false"
    - step: &apply-o11y-tfmod-test
        name: apply o11y-tfmod-test
        condition:
          changesets:
            includePaths:
              - "projects/o11y/terraform-modules/test/**"
        caches:
          - o11y-tfmod-test
        script:
          - *auth
          - terraform -chdir="projects/o11y/terraform-modules/test" init -input="false"
          - terraform -chdir="projects/o11y/terraform-modules/test" apply -input="false" -auto-approve
        trigger: manual
    - step: &test-o11y-tfsub-gcp-availability-monitor
        name: test o11y-tfsub-gcp-availability-monitor
        condition:
          changesets:
            includePaths:
              - "projects/o11y/terraform-submodules/gcp-availability-monitor/**"
        caches:
          - o11y-tfsub-gcp-availability-monitor
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/o11y/terraform-submodules/gcp-availability-monitor"
          - ./scripts/terraform-submodule test "projects/o11y/terraform-submodules/gcp-availability-monitor"
          - ./scripts/terraform-submodule pre-publish "projects/o11y/terraform-submodules/gcp-availability-monitor"
          - ./scripts/terraform-submodule show "projects/o11y/terraform-submodules/gcp-availability-monitor"
    - step: &publish-o11y-tfsub-gcp-availability-monitor
        name: publish o11y-tfsub-gcp-availability-monitor
        condition:
          changesets:
            includePaths:
              - "projects/o11y/terraform-submodules/gcp-availability-monitor/**"
        caches:
          - o11y-tfsub-gcp-availability-monitor
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/o11y/terraform-submodules/gcp-availability-monitor"
          - ./scripts/terraform-submodule test "projects/o11y/terraform-submodules/gcp-availability-monitor"
          - ./scripts/terraform-submodule publish "projects/o11y/terraform-submodules/gcp-availability-monitor"
          - ./scripts/terraform-submodule show "projects/o11y/terraform-submodules/gcp-availability-monitor"
    - step: &test-o11y-tfsub-gke-lgtm-stack
        name: test o11y-tfsub-gke-lgtm-stack
        condition:
          changesets:
            includePaths:
              - "projects/o11y/terraform-submodules/gke-lgtm-stack/**"
        caches:
          - o11y-tfsub-gke-lgtm-stack
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/o11y/terraform-submodules/gke-lgtm-stack"
          - ./scripts/terraform-submodule test "projects/o11y/terraform-submodules/gke-lgtm-stack"
          - ./scripts/terraform-submodule pre-publish "projects/o11y/terraform-submodules/gke-lgtm-stack"
          - ./scripts/terraform-submodule show "projects/o11y/terraform-submodules/gke-lgtm-stack"
    - step: &publish-o11y-tfsub-gke-lgtm-stack
        name: publish o11y-tfsub-gke-lgtm-stack
        condition:
          changesets:
            includePaths:
              - "projects/o11y/terraform-submodules/gke-lgtm-stack/**"
        caches:
          - o11y-tfsub-gke-lgtm-stack
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/o11y/terraform-submodules/gke-lgtm-stack"
          - ./scripts/terraform-submodule test "projects/o11y/terraform-submodules/gke-lgtm-stack"
          - ./scripts/terraform-submodule publish "projects/o11y/terraform-submodules/gke-lgtm-stack"
          - ./scripts/terraform-submodule show "projects/o11y/terraform-submodules/gke-lgtm-stack"
    - step: &test-o11y-tfsub-k8s-otel-collectors
        name: test o11y-tfsub-k8s-otel-collectors
        condition:
          changesets:
            includePaths:
              - "projects/o11y/terraform-submodules/k8s-otel-collectors/**"
        caches:
          - o11y-tfsub-k8s-otel-collectors
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/o11y/terraform-submodules/k8s-otel-collectors"
          - ./scripts/terraform-submodule test "projects/o11y/terraform-submodules/k8s-otel-collectors"
          - ./scripts/terraform-submodule pre-publish "projects/o11y/terraform-submodules/k8s-otel-collectors"
          - ./scripts/terraform-submodule show "projects/o11y/terraform-submodules/k8s-otel-collectors"
    - step: &publish-o11y-tfsub-k8s-otel-collectors
        name: publish o11y-tfsub-k8s-otel-collectors
        condition:
          changesets:
            includePaths:
              - "projects/o11y/terraform-submodules/k8s-otel-collectors/**"
        caches:
          - o11y-tfsub-k8s-otel-collectors
        script:
          - *auth
          - ./scripts/terraform-submodule build "projects/o11y/terraform-submodules/k8s-otel-collectors"
          - ./scripts/terraform-submodule test "projects/o11y/terraform-submodules/k8s-otel-collectors"
          - ./scripts/terraform-submodule publish "projects/o11y/terraform-submodules/k8s-otel-collectors"
          - ./scripts/terraform-submodule show "projects/o11y/terraform-submodules/k8s-otel-collectors"

pipelines:
  pull-requests:
    "**":
      - parallel:
          - step: *test-core-image-devcontainer
          - step: *test-core-image-go-rte
          - step: *test-core-image-go-sdk
          - step: *test-core-tfmod-main
          - step: *test-core-tfmod-prod
          - step: *test-core-tfmod-test
          - step: *test-core-tfsub-gcp-docker-images-registry
          - step: *test-core-tfsub-gcp-helm-charts-registry
          - step: *test-core-tfsub-gcp-project
          - step: *test-core-tfsub-gcp-terraform-modules-registry
          - step: *test-core-tfsub-gcp-terraform-state-bucket
          - step: *test-core-tfsub-gke-platform
          - step: *test-core-tfsub-gke-service-account
          - step: *test-core-tfsub-k8s-gateway-redirect
          - step: *test-core-tfsub-k8s-gateway-route
          - step: *test-core-tfsub-k8s-vault
          - step: *test-core-tfsub-k8s-workspace
          - step: *test-demo-image-kuard
          - step: *test-demo-gomod-kuard-tester
          - step: *test-demo-chart-stateful-kuard
          - step: *test-demo-chart-stateless-kuard
          - step: *test-demo-tfmod-kuard
          - step: *test-demo-tfsub-helm-manifest
          - step: *test-demo-tfsub-helm-template
          - step: *test-demo-tfsub-kuard
          - step: *test-o11y-tfmod-test
          - step: *test-o11y-tfsub-gcp-availability-monitor
          - step: *test-o11y-tfsub-gke-lgtm-stack
          - step: *test-o11y-tfsub-k8s-otel-collectors
      - parallel:
          - step: *plan-core-tfmod-main
          - step: *plan-core-tfmod-prod
          - step: *plan-core-tfmod-test
          - step: *plan-demo-tfmod-kuard
          - step: *plan-o11y-tfmod-test
  branches:
    main:
      - parallel:
          - step: *publish-core-image-devcontainer
          - step: *publish-core-image-go-rte
          - step: *publish-core-image-go-sdk
          - step: *publish-core-tfsub-gcp-docker-images-registry
          - step: *publish-core-tfsub-gcp-helm-charts-registry
          - step: *publish-core-tfsub-gcp-project
          - step: *publish-core-tfsub-gcp-terraform-modules-registry
          - step: *publish-core-tfsub-gcp-terraform-state-bucket
          - step: *publish-core-tfsub-gke-platform
          - step: *publish-core-tfsub-gke-service-account
          - step: *publish-core-tfsub-k8s-gateway-redirect
          - step: *publish-core-tfsub-k8s-gateway-route
          - step: *publish-core-tfsub-k8s-vault
          - step: *publish-core-tfsub-k8s-workspace
          - step: *publish-demo-image-kuard
          - step: *publish-demo-chart-stateful-kuard
          - step: *publish-demo-chart-stateless-kuard
          - step: *publish-demo-tfsub-helm-manifest
          - step: *publish-demo-tfsub-helm-template
          - step: *publish-demo-tfsub-kuard
          - step: *publish-o11y-tfsub-gcp-availability-monitor
          - step: *publish-o11y-tfsub-gke-lgtm-stack
          - step: *publish-o11y-tfsub-k8s-otel-collectors
      - parallel:
          - step: *plan-core-tfmod-main
          - step: *plan-core-tfmod-prod
          - step: *plan-core-tfmod-test
          - step: *plan-demo-tfmod-kuard
          - step: *plan-o11y-tfmod-test
      - parallel:
          - step: *apply-core-tfmod-main
          - step: *apply-core-tfmod-prod
          - step: *apply-core-tfmod-test
          - step: *apply-demo-tfmod-kuard
          - step: *apply-o11y-tfmod-test
